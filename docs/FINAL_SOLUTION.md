# –ò—Ç–æ–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ –≤—Å–µ—Ö –ø—Ä–æ–±–ª–µ–º

## ‚úÖ –ü—Ä–æ–±–ª–µ–º—ã —Ä–µ—à–µ–Ω—ã

### 1. –û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
**–ü—Ä–æ–±–ª–µ–º–∞:** `–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö. –û–ø–ª–∞—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.`

**–†–µ—à–µ–Ω–∏–µ:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—Å—ã–ª–∫–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ü—Ä–æ–¥–∞–º—É—Å
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è HMAC –ø–æ–¥–ø–∏—Å—å —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- ‚úÖ –í—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —è–≤–Ω–æ

### 2. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL webhook
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ–¥–∞–º—É—Å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ `/sales/prodamus`, –±–æ—Ç —Å–ª—É—à–∞–µ—Ç `/webhook/prodamus`

**–†–µ—à–µ–Ω–∏–µ:**
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω –ø—É—Ç—å webhook –Ω–∞ `/sales/prodamus`
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ —Ç–µ—Å—Ç—ã
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ª–æ–≥–∏

### 3. PageKite –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
**–ü—Ä–æ–±–ª–µ–º–∞:** PageKite - —Ç—É–Ω–Ω–µ–ª–∏—Ä—É—é—â–∏–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

**–†–µ—à–µ–Ω–∏–µ:**
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –¥–µ–ø–ª–æ—é

## üöÄ –§–∏–Ω–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### 1. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
# Telegram Bot Configuration
TELEGRAM_BOT_TOKEN=your_real_bot_token
TELEGRAM_CHANNEL_ID=@your_private_channel

# Prodamus Configuration
PRODAMUS_SHOP_ID=your_real_shop_id
PRODAMUS_SECRET_KEY=your_real_secret_key
PRODAMUS_PAYMENT_FORM_URL=https://your-shop.payform.ru/pay
PRODAMUS_REST_API_URL=https://payform.ru
PRODAMUS_WEBHOOK_URL=https://yourdomain.com/sales/prodamus

# Server Configuration
PORT=3000
WEBHOOK_URL=https://yourdomain.com
WEBHOOK_PATH=/webhook/telegram

# Subscription Configuration
SUBSCRIPTION_PRICE=1000
SUBSCRIPTION_DURATION_DAYS=30
CURRENCY=RUB
```

### 2. –ü–æ–ª–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å—Å—ã–ª–∫–∏

```
https://your-shop.payform.ru/?do=pay&sys=your_shop_id&order_id=12345&amount=1000&currency=RUB&description=–ü–æ–¥–ø–∏—Å–∫–∞+–Ω–∞+–∑–∞–∫—Ä—ã—Ç—ã–π+–∫–∞–Ω–∞–ª&client_email=123456789%40telegram.user&success_url=https%3A%2F%2Fyourdomain.com%2Fsuccess&failure_url=https%3A%2F%2Fyourdomain.com%2Ffailure&webhook_url=https%3A%2F%2Fyourdomain.com%2Fsales%2Fprodamus&custom_fields=%7B%22telegram_user_id%22%3A%22123456789%22%7D&signature=8832f6193cfc55d2cb8db600c29a2208d6f2b4e59c324665ba2271be72e3b5f7
```

### 3. Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞

```javascript
// –ü—É—Ç—å: /sales/prodamus
app.post('/sales/prodamus', (req, res) => {
    const signature = req.headers['Sign'];
    const body = req.body;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ HMAC –ø–æ–¥–ø–∏—Å–∏
    const isValidSignature = prodamusService.verifyWebhookSignature(body, signature);
    
    if (!isValidSignature) {
        return res.status(400).json({ error: 'Invalid signature' });
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞
    subscriptionService.processPayment(body);
    
    res.json({ status: 'success' });
});
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç

```
Test Suites: 7 passed, 7 total
Tests:       60 passed, 60 total
```

### üìà –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞

- **–û–±—â–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ:** 69.15%
- **–í–µ—Ç–∫–∏:** 52.33%
- **–§—É–Ω–∫—Ü–∏–∏:** 65.57%
- **–°—Ç—Ä–æ–∫–∏:** 70.29%

## üõ† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è

### 1. HMAC –ø–æ–¥–ø–∏—Å—å

```javascript
createHmacSignature(data) {
    const sortedKeys = Object.keys(data).sort();
    const signatureString = sortedKeys
        .map(key => `${key}=${data[key]}`)
        .join('&');
        
    return crypto
        .createHmac('sha256', this.secretKey)
        .update(signatureString, 'utf8')
        .digest('hex');
}
```

### 2. REST API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

```javascript
// –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
await prodamusService.activateSubscription(subscriptionId, tgUserId);

// –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
await prodamusService.deactivateSubscription(subscriptionId, tgUserId);

// –û—Ç–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
await prodamusService.unsubscribeUser(subscriptionId, tgUserId);
```

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook'–æ–≤

```javascript
// –î–∞–Ω–Ω—ã–µ –æ—Ç –ü—Ä–æ–¥–∞–º—É—Å
{
  "order_id": "12345",
  "payment_status": "success",
  "sum": "1000.00",
  "customer_email": "user@example.com",
  "custom_fields": "{\"telegram_user_id\":\"123456789\"}"
}
```

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### 1. –û—Å–Ω–æ–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- **README.md** - –æ–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
- **SETUP.md** - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ
- **API.md** - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º
- **FIX_PAYMENT.md** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
- **SIGNATURE_FIX.md** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ HMAC –ø–æ–¥–ø–∏—Å–∏
- **WEBHOOK_URL_FIX.md** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ URL webhook'–∞
- **FULL_PAYMENT_LINK.md** - –ø–æ–ª–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—Å—ã–ª–∫–∏

### 3. –ü—Ä–æ–¥–∞–∫—à–µ–Ω
- **PRODUCTION_SETUP.md** - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
- **DEPLOYMENT.md** - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –¥–µ–ø–ª–æ—é
- **SECURITY.md** - –≤–æ–ø—Ä–æ—Å—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- **TESTING.md** - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
- **TESTS_FIXED.md** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤

## üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

### ‚úÖ –ß—Ç–æ –≥–æ—Ç–æ–≤–æ

1. **–ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ü—Ä–æ–¥–∞–º—É—Å**
   - –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å—Å—ã–ª–æ–∫
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook'–æ–≤
   - HMAC –ø–æ–¥–ø–∏—Å—å

2. **REST API —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**
   - –ê–∫—Ç–∏–≤–∞—Ü–∏—è/–¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–æ–∫
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
   - –û—Ç–ø–∏—Å–∫–∞ –æ—Ç –ø–æ–¥–ø–∏—Å–æ–∫

3. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**
   - –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

4. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**
   - –ü–æ–ª–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
   - –ü—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
   - Troubleshooting

### üîß –ß—Ç–æ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å

1. **–†–µ–∞–ª—å–Ω—ã–π –¥–æ–º–µ–Ω**
   - –ó–∞–º–µ–Ω–∏—Ç—å `yourdomain.com` –Ω–∞ –≤–∞—à –¥–æ–º–µ–Ω
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å HTTPS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
   - –û–±–µ—Å–ø–µ—á–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å 24/7

2. **–ü—Ä–æ–¥–∞–∫—à–µ–Ω —Ö–æ—Å—Ç–∏–Ω–≥**
   - VPS –∏–ª–∏ –æ–±–ª–∞—á–Ω—ã–π —Å–µ—Ä–≤–∏—Å
   - PM2 –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

3. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ –ü—Ä–æ–¥–∞–º—É—Å**
   - –£–∫–∞–∑–∞—Ç—å webhook URL: `https://yourdomain.com/sales/prodamus`
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### 1. –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ
```bash
# 1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ .env —Ñ–∞–π–ª —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
cp config.env.example .env
nano .env

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã
npm test

# 3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
npm run test:payment
```

### 2. –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
```bash
# 1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–µ—Ä–≤–µ—Ä —Å —Ä–µ–∞–ª—å–Ω—ã–º –¥–æ–º–µ–Ω–æ–º
# 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
# 3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ PM2
# 4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ webhook'–∏
```

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
```bash
# 1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
# 2. –î–æ–±–∞–≤—å—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
# 3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
```

## üéâ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã —Ä–µ—à–µ–Ω—ã! –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ:

- ‚úÖ **–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π** - –ø–æ–ª–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—Å—ã–ª–æ–∫
- ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ webhook'–æ–≤** - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –∏ –ø–æ–¥–ø–∏—Å—å
- ‚úÖ **REST API** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏
- ‚úÖ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- ‚úÖ **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** - –ø–æ–ª–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞—Ç—å –±–æ—Ç–∞ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ! üöÄ
