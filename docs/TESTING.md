# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

–ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é Telegram –±–æ—Ç–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ –ø–æ–¥–ø–∏—Å–æ–∫.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

```
tests/
‚îú‚îÄ‚îÄ bot.test.js              # –¢–µ—Å—Ç—ã –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–æ—Ç–∞
‚îú‚îÄ‚îÄ hmacService.test.js      # –¢–µ—Å—Ç—ã HMAC —Å–µ—Ä–≤–∏—Å–∞
‚îú‚îÄ‚îÄ subscriptionService.test.js # –¢–µ—Å—Ç—ã —Å–µ—Ä–≤–∏—Å–∞ –ø–æ–¥–ø–∏—Å–æ–∫
‚îú‚îÄ‚îÄ prodamusService.test.js  # –¢–µ—Å—Ç—ã —Å–µ—Ä–≤–∏—Å–∞ –ü—Ä–æ–¥–∞–º—É—Å
‚îú‚îÄ‚îÄ botHandlers.test.js      # –¢–µ—Å—Ç—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –±–æ—Ç–∞
‚îú‚îÄ‚îÄ integration.test.js       # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
‚îú‚îÄ‚îÄ test-payment.js          # –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
‚îú‚îÄ‚îÄ test-order-id.js         # –¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–æ–≤ –∑–∞–∫–∞–∑–æ–≤
‚îî‚îÄ‚îÄ setup.js                 # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```

## –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

### –í—Å–µ —Ç–µ—Å—Ç—ã
```bash
npm test
```

### –¢–µ—Å—Ç—ã —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
```bash
npm test -- --coverage
```

### –û—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã
```bash
# –¢–µ—Å—Ç—ã —Å–µ—Ä–≤–∏—Å–æ–≤
npm test -- hmacService.test.js
npm test -- subscriptionService.test.js
npm test -- prodamusService.test.js

# –¢–µ—Å—Ç—ã –±–æ—Ç–∞
npm test -- bot.test.js
npm test -- botHandlers.test.js

# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
npm test -- integration.test.js
```

### –¢–µ—Å—Ç—ã –≤ —Ä–µ–∂–∏–º–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è
```bash
npm run test:watch
```

## –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã

### –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
```bash
npm run test:payment
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
```
‚úÖ –ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!
üîó URL: https://dashastar.payform.ru/pay?...
```

### –¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–æ–≤ –∑–∞–∫–∞–∑–æ–≤
```bash
node tests/test-order-id.js
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
```
1. 58133 ‚úÖ
2. 47478 ‚úÖ
...
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä—É—á–Ω—É—é

### 1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–æ—Ç–∞

1. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:**
```bash
npm start
```

2. **–ù–∞–π–¥–∏—Ç–µ –±–æ—Ç–∞ –≤ Telegram:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ Telegram
   - –ù–∞–π–¥–∏—Ç–µ –±–æ—Ç–∞ –ø–æ username
   - –û—Ç–ø—Ä–∞–≤—å—Ç–µ `/start`

3. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã:**
   - `/start` - –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
   - `/help` - —Å–ø—Ä–∞–≤–∫–∞
   - `/subscribe` - –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
   - `/status` - —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏

### 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π

1. **–°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂:**
   - –û—Ç–ø—Ä–∞–≤—å—Ç–µ `/subscribe`
   - –ù–∞–∂–º–∏—Ç–µ "–û–ø–ª–∞—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É"
   - –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Å—ã–ª–∫—É:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É –≤ –±—Ä–∞—É–∑–µ—Ä–µ
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–ª–∞—Ç–µ–∂–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã

3. **–¢–µ—Å—Ç–æ–≤–∞—è –æ–ø–ª–∞—Ç–∞:**
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ webhook –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ webhook'–æ–≤

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞:**
```bash
curl https://yourdomain.com/status
```

2. **–¢–µ—Å—Ç Telegram webhook:**
```bash
curl -X POST https://yourdomain.com/webhook/telegram \
  -H "Content-Type: application/json" \
  -d '{"message":{"text":"/start","chat":{"id":123},"from":{"id":456}}}'
```

3. **–¢–µ—Å—Ç –ü—Ä–æ–¥–∞–º—É—Å webhook:**
```bash
curl -X POST https://yourdomain.com/webhook/prodamus \
  -H "Content-Type: application/json" \
  -H "Sign: test_signature" \
  -d '{"order_id":"12345","status":"success","amount":"1000"}'
```

## –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –¢–µ—Å—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Apache Bench
sudo apt install apache2-utils

# –¢–µ—Å—Ç 100 –∑–∞–ø—Ä–æ—Å–æ–≤ —Å 10 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–º–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏
ab -n 100 -c 10 https://yourdomain.com/status
```

### 2. –¢–µ—Å—Ç webhook'–æ–≤

```bash
# –°–æ–∑–¥–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
cat > test-webhooks.sh << 'EOF'
#!/bin/bash
for i in {1..50}; do
  curl -X POST https://yourdomain.com/webhook/prodamus \
    -H "Content-Type: application/json" \
    -H "Sign: test_signature" \
    -d "{\"order_id\":\"$i\",\"status\":\"success\",\"amount\":\"1000\"}" &
done
wait
echo "All requests completed"
EOF

chmod +x test-webhooks.sh
./test-webhooks.sh
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### 1. –¢–µ—Å—Ç HMAC –ø–æ–¥–ø–∏—Å–µ–π

```bash
# –¢–µ—Å—Ç —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ–¥–ø–∏—Å—å—é
curl -X POST https://yourdomain.com/webhook/prodamus \
  -H "Content-Type: application/json" \
  -H "Sign: valid_signature" \
  -d '{"order_id":"12345","status":"success"}'

# –¢–µ—Å—Ç —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ–¥–ø–∏—Å—å—é
curl -X POST https://yourdomain.com/webhook/prodamus \
  -H "Content-Type: application/json" \
  -H "Sign: invalid_signature" \
  -d '{"order_id":"12345","status":"success"}'
```

### 2. –¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö

```bash
# –¢–µ—Å—Ç —Å –ø—É—Å—Ç—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
curl -X POST https://yourdomain.com/webhook/prodamus \
  -H "Content-Type: application/json" \
  -d '{}'

# –¢–µ—Å—Ç —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
curl -X POST https://yourdomain.com/webhook/prodamus \
  -H "Content-Type: application/json" \
  -d '{"invalid":"data"}'
```

## –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. GitHub Actions

–°–æ–∑–¥–∞–π—Ç–µ `.github/workflows/test.yml`:

```yaml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Setup Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run tests
      run: npm test
      
    - name: Run payment test
      run: npm run test:payment
```

### 2. –õ–æ–∫–∞–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã

```bash
# –°–æ–∑–¥–∞–π—Ç–µ test-all.sh
cat > test-all.sh << 'EOF'
#!/bin/bash

echo "üß™ –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤..."

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
npm install

# –ó–∞–ø—É—Å–∫ unit —Ç–µ—Å—Ç–æ–≤
echo "üìã Unit —Ç–µ—Å—Ç—ã..."
npm test

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –ø–ª–∞—Ç–µ–∂–µ–π
echo "üí≥ –¢–µ—Å—Ç –ø–ª–∞—Ç–µ–∂–µ–π..."
npm run test:payment

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –Ω–æ–º–µ—Ä–æ–≤ –∑–∞–∫–∞–∑–æ–≤
echo "üî¢ –¢–µ—Å—Ç –Ω–æ–º–µ—Ä–æ–≤ –∑–∞–∫–∞–∑–æ–≤..."
node tests/test-order-id.js

echo "‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã!"
EOF

chmod +x test-all.sh
./test-all.sh
```

## –û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤

### 1. –ü–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥

```bash
# –ó–∞–ø—É—Å–∫ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
npm test -- --verbose

# –ó–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
npm test -- --testNamePattern="should create payment"
```

### 2. –û—Ç–ª–∞–¥–∫–∞ –≤ IDE

```javascript
// –î–æ–±–∞–≤—å—Ç–µ –≤ —Ç–µ—Å—Ç
describe('Debug Test', () => {
  test('should debug payment creation', async () => {
    console.log('Debug: Starting payment test');
    
    const result = await prodamusService.createPayment(paymentData);
    
    console.log('Debug: Payment result:', result);
    expect(result.success).toBe(true);
  });
});
```

### 3. –õ–æ–≥–∏ —Ç–µ—Å—Ç–æ–≤

```bash
# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –≤ —Ñ–∞–π–ª
npm test > test-results.log 2>&1

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
tail -f test-results.log
```

## –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞

### 1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞

```bash
npm test -- --coverage
```

### 2. –ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç—á–µ—Ç–∞

```bash
# –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
open coverage/lcov-report/index.html
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è

–í `jest.config.js`:

```javascript
module.exports = {
  collectCoverageFrom: [
    'src/**/*.js',
    '!src/**/*.test.js',
    '!src/**/node_modules/**'
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80
    }
  }
};
```

## –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### 1. Pre-commit —Ö—É–∫–∏

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ husky
npm install --save-dev husky

# –ù–∞—Å—Ç—Ä–æ–π—Ç–µ pre-commit
npx husky add .husky/pre-commit "npm test"
```

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã

```bash
# –°–æ–∑–¥–∞–π—Ç–µ test-ci.sh
cat > test-ci.sh << 'EOF'
#!/bin/bash
set -e

echo "üöÄ –ó–∞–ø—É—Å–∫ CI —Ç–µ—Å—Ç–æ–≤..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
echo "üìù –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞..."
npm run lint

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
npm test

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è..."
npm test -- --coverage --coverageThreshold.global.lines=80

echo "‚úÖ CI —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã!"
EOF

chmod +x test-ci.sh
```

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

- **Unit —Ç–µ—Å—Ç—ã** - –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
- **Integration —Ç–µ—Å—Ç—ã** - –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- **E2E —Ç–µ—Å—Ç—ã** - –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### 2. –ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤

```javascript
describe('ProdamusService', () => {
  describe('createPayment', () => {
    test('should create payment URL successfully', () => {
      // —Ç–µ—Å—Ç
    });
    
    test('should handle payment creation error', () => {
      // —Ç–µ—Å—Ç
    });
  });
});
```

### 3. –ú–æ–∫–∏ –∏ —Å—Ç–∞–±—ã

```javascript
// –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–æ–∫–∏ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
jest.mock('axios');
jest.mock('node-telegram-bot-api');

// –°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Å—Ç–∞–±—ã –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
const mockBot = {
  sendMessage: jest.fn(),
  onText: jest.fn()
};
```

### 4. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

```javascript
test('should handle async operation', async () => {
  const result = await someAsyncFunction();
  expect(result).toBeDefined();
});
```

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### 1. –¢–µ—Å—Ç—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è

```bash
# –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞
npm test -- --clearCache

# –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
rm -rf node_modules package-lock.json
npm install
```

### 2. –ú–æ–∫–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç

```javascript
// –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–æ–∫–∏ —Å–æ–∑–¥–∞–Ω—ã –¥–æ –∏–º–ø–æ—Ä—Ç–∞
jest.mock('../src/services/prodamusService');

const ProdamusService = require('../src/services/prodamusService');
```

### 3. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏

```javascript
// –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ async/await
test('should handle async error', async () => {
  await expect(asyncFunction()).rejects.toThrow('Error message');
});
```
